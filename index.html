<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SciMaster: Global STEM Hub</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --sec: #3498db;
        }

        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            background-color: var(--primary);
        }

        .card {
            transition: 0.3s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .latex-preview {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            min-height: 60px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1.1rem;
        }

        .latex-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .latex-toolbar button {
            width: 45px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .category-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .subcat-tag {
            position: absolute;
            top: 32px;
            right: 10px;
            font-size: 0.65rem;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        #loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
        }

        .subcat-pills {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }

        .subcat-pills::-webkit-scrollbar {
            height: 4px;
        }

        .subcat-pills::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="loading-spinner" class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-atom"></i> SciMaster</a>
            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navC">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navC">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" onclick="setMainFilter('All')">All</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="setMainFilter('Math')">Math</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="setMainFilter('Physics')">Physics</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="setMainFilter('Chemistry')">Chemistry</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="setMainFilter('Biology')">Biology</a></li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3"><i class="fas fa-star text-warning"></i> <b id="display-points">0</b></span>
                    <button class="btn btn-sm btn-outline-light" onclick="toggleAdmin()">Admin</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-3">
        <div id="subcat-container" class="subcat-pills d-flex gap-2 hidden"></div>
    </div>

    <div class="container mt-3 hidden" id="admin-controls">
        <div class="card bg-white border-warning">
            <div class="card-body d-flex justify-content-between align-items-center">
                <h5 class="text-warning mb-0"><i class="fas fa-user-shield"></i> Admin Panel</h5>
                <div>
                    <button class="btn btn-success" onclick="openEditor()">+ Exercise</button>
                    <button class="btn btn-info text-white" onclick="openSubcatModal()">+ Subcategory</button>
                    <button class="btn btn-danger" onclick="logoutAdmin()">Exit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5">
        <div id="quiz-grid" class="row g-4"></div>
    </div>

    <div class="modal fade" id="loginModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Login</h5>
                </div>
                <div class="modal-body">
                    <input type="password" id="admin-pass" class="form-control" placeholder="Enter Password">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="verifyAdmin()">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="subcatModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Subcategory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Parent Category</label>
                    <select id="new-subcat-parent" class="form-select mb-3">
                        <option>Math</option>
                        <option>Physics</option>
                        <option>Chemistry</option>
                        <option>Biology</option>
                    </select>
                    <label class="form-label">Subcategory Name</label>
                    <input type="text" id="new-subcat-name" class="form-control" placeholder="e.g. Algebra">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="createSubcat()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editorModal" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">Create Exercise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <select id="ed-cat" class="form-select" onchange="updateEditorSubcats()">
                                <option>Math</option>
                                <option>Physics</option>
                                <option>Chemistry</option>
                                <option>Biology</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Subcategory</label>
                            <select id="ed-subcat" class="form-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Points</label>
                            <input type="number" id="ed-pts" class="form-control" value="10">
                        </div>

                        <div class="col-12">
                            <label class="form-label">LaTeX Tools</label>
                            <div class="latex-toolbar">
                                <button class="btn btn-light border" title="Fraction" onclick="addTex('\\frac{x}{y}')">$\frac{x}{y}$</button>
                                <button class="btn btn-light border" title="Square Root" onclick="addTex('\\sqrt{x}')">$\sqrt{x}$</button>
                                <button class="btn btn-light border" title="Exponent" onclick="addTex('x^{n}')">$x^n$</button>
                                <button class="btn btn-light border" title="Subscript" onclick="addTex('x_{n}')">$x_n$</button>
                                <button class="btn btn-light border" title="Multiplication" onclick="addTex('\\times')">$\times$</button>
                                <button class="btn btn-light border" title="Division" onclick="addTex('\\div')">$\div$</button>
                                <button class="btn btn-light border" title="Plus Minus" onclick="addTex('\\pm')">$\pm$</button>
                                <button class="btn btn-light border" title="Pi" onclick="addTex('\\pi')">$\pi$</button>
                                <button class="btn btn-light border" title="Theta" onclick="addTex('\\theta')">$\theta$</button>
                                <button class="btn btn-light border" title="Alpha" onclick="addTex('\\alpha')">$\alpha$</button>
                                <button class="btn btn-light border" title="Delta" onclick="addTex('\\Delta')">$\Delta$</button>
                                <button class="btn btn-light border" title="Integral" onclick="addTex('\\int_{a}^{b}')">$\int$</button>
                                <button class="btn btn-light border" title="Sum" onclick="addTex('\\sum')">$\sum$</button>
                                <button class="btn btn-light border" title="Infinity" onclick="addTex('\\infty')">$\infty$</button>
                                <button class="btn btn-light border" title="Arrow" onclick="addTex('\\rightarrow')">$\rightarrow$</button>
                                <button class="btn btn-light border" title="Degree" onclick="addTex('^{\\circ}')">$^{\circ}$</button>
                                <button class="btn btn-light border" title="Vector" onclick="addTex('\\vec{v}')">$\vec{v}$</button>
                                <button class="btn btn-light border" title="Approx" onclick="addTex('\\approx')">$\approx$</button>
                                <button class="btn btn-light border" title="Bold Text" onclick="addTex('\\mathbf{text}')"><i class="fas fa-bold"></i></button>
                                <button class="btn btn-light border" title="Regular Text" onclick="addTex('\\text{word}')"><i class="fas fa-font"></i></button>
                            </div>
                            <label class="form-label">Question</label>
                            <textarea id="ed-q" class="form-control font-monospace" rows="4" oninput="renderPreview()"></textarea>
                            <div id="ed-preview" class="latex-preview text-muted"></div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Correct Answers (comma separated)</label>
                            <input type="text" id="ed-ans" class="form-control" placeholder="e.g. 5, five, 5.0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="uploadExercise()">Upload Exercise</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVp9UP-NNUAAjtB1iBw6Q7YffWZDran8Q",
            authDomain: "science-exercises.firebaseapp.com",
            databaseURL: "https://science-exercises-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "science-exercises",
            storageBucket: "science-exercises.firebasestorage.app",
            messagingSenderId: "592572802756",
            appId: "1:592572802756:web:51a7e1e55dea98cc950b91",
            measurementId: "G-H7HW0PYGGW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allExercises = [];
        let subCategories = {};
        let isAdmin = false;
        let mainFilter = 'All';
        let subFilter = 'All';
        let userPoints = 0;
        let userSolved = {};

        let userID = localStorage.getItem('sci_uid');
        if (!userID) {
            userID = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sci_uid', userID);
        }

        const ADMIN_PASS = "admin123";

        window.onload = function() {
            db.ref('exercises').on('value', (snapshot) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                const data = snapshot.val();
                allExercises = [];
                if (data) {
                    Object.keys(data).forEach(key => {
                        allExercises.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                renderGrid();
            });

            db.ref('settings/subcats').on('value', (snap) => {
                subCategories = snap.val() || {};
                renderSubcatBar();
            });

            db.ref('users/' + userID + '/points').on('value', (snap) => {
                userPoints = snap.val() || 0;
                document.getElementById('display-points').innerText = userPoints;
            });

            db.ref('users/' + userID + '/solved').on('value', (snap) => {
                userSolved = snap.val() || {};
                renderGrid();
            });
        };

        function renderGrid() {
            const container = document.getElementById('quiz-grid');
            container.innerHTML = '';

            let filtered = allExercises;

            if (mainFilter !== 'All') {
                filtered = filtered.filter(e => e.cat === mainFilter);
                if (subFilter !== 'All') {
                    filtered = filtered.filter(e => e.subcat === subFilter);
                }
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5"><h4>No exercises found in this section.</h4></div>';
                return;
            }

            filtered.forEach(ex => {
                const isSolved = userSolved[ex.id] ? true : false;

                const adminBtn = isAdmin ?
                    `<button class="btn btn-sm btn-outline-danger mt-2 w-100" onclick="deleteEx('${ex.id}')"><i class="fas fa-trash"></i> Delete</button>
                 <div class="mt-1 text-muted small">Ans: ${ex.ans.join(', ')}</div>` : '';

                const subLabel = ex.subcat ? `<span class="badge bg-info text-dark subcat-tag">${ex.subcat}</span>` : '';

                const html = `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 ${isSolved ? 'border-success' : ''}">
                        <div class="card-body position-relative">
                            <span class="badge bg-secondary category-tag">${ex.cat}</span>
                            ${subLabel}
                            <h5 class="card-title mt-3">
                                <span class="badge bg-warning text-dark">${ex.pts} Pts</span>
                                ${isSolved ? '<i class="fas fa-check-circle text-success ms-2"></i>' : ''}
                            </h5>
                            <div class="card-text my-3 p-3 bg-light rounded border">${ex.q}</div>
                            
                            ${!isSolved ? `
                            <div class="input-group">
                                <input type="text" id="in-${ex.id}" class="form-control" placeholder="Answer...">
                                <button class="btn btn-primary" onclick="submitAns('${ex.id}')">Check</button>
                            </div>
                            ` : '<div class="alert alert-success py-2 text-center mb-0"><strong>Solved!</strong> Great job.</div>'}
                            
                            ${adminBtn}
                        </div>
                    </div>
                </div>
            `;
                container.innerHTML += html;
            });

            MathJax.typesetPromise();
        }

        function renderSubcatBar() {
            const con = document.getElementById('subcat-container');
            con.innerHTML = '';

            if (mainFilter === 'All' || !subCategories[mainFilter]) {
                con.classList.add('hidden');
                return;
            }

            con.classList.remove('hidden');

            const allBtn = document.createElement('span');
            allBtn.className = `badge rounded-pill p-2 px-3 border cursor-pointer ${subFilter === 'All' ? 'bg-dark' : 'bg-secondary'}`;
            allBtn.innerText = 'All ' + mainFilter;
            allBtn.onclick = () => setSubFilter('All');
            con.appendChild(allBtn);

            Object.values(subCategories[mainFilter]).forEach(s => {
                const btn = document.createElement('span');
                btn.className = `badge rounded-pill p-2 px-3 border cursor-pointer ${subFilter === s ? 'bg-dark' : 'bg-secondary'}`;
                btn.innerText = s;
                btn.onclick = () => setSubFilter(s);
                con.appendChild(btn);
            });
        }

        function setMainFilter(cat) {
            mainFilter = cat;
            subFilter = 'All';
            
            document.querySelectorAll('.navbar-nav .nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            
            renderSubcatBar();
            renderGrid();
        }

        function setSubFilter(sub) {
            subFilter = sub;
            renderSubcatBar(); 
            renderGrid();
        }

        function submitAns(id) {
            const input = document.getElementById('in-' + id);
            const val = input.value.trim().toLowerCase();
            const exercise = allExercises.find(e => e.id === id);

            const correct = exercise.ans.some(a => a.toLowerCase() === val);

            if (correct) {
                db.ref('users/' + userID + '/points').set(userPoints + parseInt(exercise.pts));
                db.ref('users/' + userID + '/solved/' + id).set(true);
            } else {
                input.classList.add('is-invalid');
                setTimeout(() => input.classList.remove('is-invalid'), 2000);
            }
        }

        function toggleAdmin() {
            if (isAdmin) return;
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        function verifyAdmin() {
            if (document.getElementById('admin-pass').value === ADMIN_PASS) {
                isAdmin = true;
                document.getElementById('admin-controls').classList.remove('hidden');
                renderGrid();
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } else {
                alert("Wrong password");
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('admin-controls').classList.add('hidden');
            renderGrid();
        }

        function openEditor() {
            updateEditorSubcats();
            new bootstrap.Modal(document.getElementById('editorModal')).show();
        }

        function openSubcatModal() {
            new bootstrap.Modal(document.getElementById('subcatModal')).show();
        }

        function createSubcat() {
            const p = document.getElementById('new-subcat-parent').value;
            const n = document.getElementById('new-subcat-name').value.trim();
            if (!n) return;

            db.ref('settings/subcats/' + p).push(n);
            bootstrap.Modal.getInstance(document.getElementById('subcatModal')).hide();
            document.getElementById('new-subcat-name').value = '';
        }

        function updateEditorSubcats() {
            const cat = document.getElementById('ed-cat').value;
            const subSel = document.getElementById('ed-subcat');
            subSel.innerHTML = '<option value="">None</option>';

            if (subCategories[cat]) {
                Object.values(subCategories[cat]).forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.text = s;
                    subSel.appendChild(opt);
                });
            }
        }

        function uploadExercise() {
            const cat = document.getElementById('ed-cat').value;
            const subcat = document.getElementById('ed-subcat').value;
            const pts = document.getElementById('ed-pts').value;
            const q = document.getElementById('ed-q').value;
            const ansRaw = document.getElementById('ed-ans').value;

            if (!q || !ansRaw) return alert("Please fill all fields");

            const ans = ansRaw.split(',').map(s => s.trim());

            db.ref('exercises').push({
                cat: cat,
                subcat: subcat,
                pts: pts,
                q: q,
                ans: ans,
                timestamp: Date.now()
            }, (error) => {
                if (!error) {
                    bootstrap.Modal.getInstance(document.getElementById('editorModal')).hide();
                    document.getElementById('ed-q').value = '';
                    document.getElementById('ed-ans').value = '';
                    document.getElementById('ed-preview').innerHTML = '';
                }
            });
        }

        function deleteEx(id) {
            if (confirm("Are you sure you want to delete this exercise?")) {
                db.ref('exercises/' + id).remove();
            }
        }

        function addTex(code) {
            const field = document.getElementById('ed-q');
            const start = field.selectionStart;
            
            const wrapped = `\\(${code}\\)`;
            
            field.value = field.value.substring(0, start) + wrapped + field.value.substring(field.selectionEnd);
            
            renderPreview();
            field.focus();
            field.setSelectionRange(start + wrapped.length, start + wrapped.length);
        }

        function renderPreview() {
            const content = document.getElementById('ed-q').value;
            const p = document.getElementById('ed-preview');
            p.innerHTML = content;
            MathJax.typesetPromise([p]);
        }
    </script>
</body>
</html>
